<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>分类查询</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="../../static/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="../../static/layuiadmin/style/admin.css" media="all">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_935338_5w3z4hpqzs7.css">
</head>
<body>

<style>
    table tr {
        height: 30px;
    }
    table tr a {
        color: #01AAED;
    }
    .layui-badge a {
        color: #fff;
    }
</style>

<div class="layui-fluid">
    <div class="layui-row layui-col-space15">

        <div class="layui-col-sm12">
            <div class="layui-card">
                <div class="layui-card-body">
                    <span>实体分类</span>
                    <span class="tanShu layui-btn layui-btn-sm" style="float: right;">
                        <i class="iconfont layui-extend-tubiaoshu"></i>&nbsp;显示分类树
                    </span>
                </div>
            </div>
        </div>
        <div class="layui-col-sm9">
            <div class="layui-card">
                <div class="layui-card-header"  style="font-size: 20px; font-weight: bold;">
                    <span>专题：</span>
                    <a href="javascript:void(0);" class="tanShu">【<span id="title"></span>】</a>
                </div>
                <div id="node" class="layui-card-body"></div>
            </div>
        </div>
        <div class="layui-col-sm3">
            <div class="layui-card">
                <div class="layui-card-header">上级分类</div>
                <div class="layui-card-body">
                    <table id="shangji" style="margin-left: 10px; width: 100%;"></table>
                </div>
            </div>
        </div>
        <div class="layui-col-sm3">
            <div class="layui-card">
                <div class="layui-card-header">下级分类</div>
                <div class="layui-card-body">
                    <table id="xiaji" style="margin-left: 10px; width: 100%;"></table>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="hidden" class="layui-fluid" hidden>
    <div class="layui-row layui-col-space15">

        <ul id="tree"></ul>

    </div>
</div>
{% csrf_token %}
<script src="../../static/layuiadmin/layui/layui.js"></script>
<script>
    layui.config({
        base: '../../../static/layuiadmin/' //静态资源所在路径
    }).extend({
        index: 'lib/index' //主入口模块
    }).use(['index', 'tree'], function () {
        var $ = layui.$;
        var layer = layui.layer;

        //全局化data
        var fullData = '';
        $.ajax({
            url: "getFenlei",
            success: function (data) {
                if (data.fenlei.length !== 0) {
                    fullData = data.fenlei;
                    setData(data.fenlei[0]);
                    setEntity(data.fenlei[0]);
                } else {
                    noData();
                }
                // 树
                layui.tree({
                    elem: '#tree',
                    nodes: data.fenlei,
                    click: function(node){
                        //只有叶子节点才可以触发事件
                        // if (node.children === undefined || node.children.length === 0) {
                        //     console.log(node);
                        // }
                        if (node !== undefined && node !== '') {
                            setData(node);
                            setEntity(node);
                        } else {
                            noData();
                        }
                    }
                });
            },
            error: function (result) {
                noData();
            }
        });

        //点击按钮弹窗
        $(".tanShu").on('click', function () {
            layer.open({
                title: '<i class="iconfont layui-extend-tubiaoshu"></i>&nbsp;分类树',
                type: 1,
                shadeClose: true,
                skin: 'layui-layer-rim', //加上边框
                area: ['300px', '480px'], //宽高
                content: $("#hidden")
            });
        });

        //替换上下级分类
        function setData(data){
            $("#title").html(data.name);
            if (data.parent === "") {
                $("#shangji").html("<center>无上级分类&nbsp;&nbsp;&nbsp;&nbsp;</center>");
            } else {
                $("#shangji").html(
                    '<tr><td>\n' +
                    '<a href="javascript:void(0);" onclick="getFenlei(\'parentNode\', \'' + data.id + '\')">\n' +
                    '<i class="iconfont layui-extend-iconfontzhizuobiaozhun47"></i>' +
                    '&nbsp;' + data.parent + '\n' +
                    '</a>\n' +
                    '</td></tr>');
            }
            if (data.children.length !== 0) {
                $("#xiaji").empty();
                for (var i = 0; i < data.children.length; i++) {
                    $("#xiaji").append(
                        '<tr><td>\n' +
                        '<a href="javascript:void(0);" onclick="getFenlei(\'selfNode\', \'' + data.children[i].id + '\')">\n' +
                        '<i class="iconfont layui-extend-iconfontzhizuobiaozhun47"></i>' +
                        '&nbsp;' + data.children[i].name + '\n' +
                        '</a>\n' +
                        '</td></tr>');
                }
            } else {
                $("#xiaji").html("<center>无下级分类&nbsp;&nbsp;&nbsp;&nbsp;</center>");
            }
        }

        function noData(){
            $("#shangji").empty().html("<center>无数据&nbsp;&nbsp;&nbsp;&nbsp;</center>");
            $("#xiaji").empty().html("<center>无数据&nbsp;&nbsp;&nbsp;&nbsp;</center>");
            $("#node").empty().html("<center>无数据</center>");
            $("#tree").empty().html("<center>暂无数据</center>");
        }

        //获取指定id的分类
        var parentNode = null;
        var selfNode = null;
        function getJ(id, data, num){
            //递归深度
            num = num || 1;
            //当前节点层数
            var cs = parseInt(id.substr(id.length - 1, 1));
            console.log("要查询的节点是：" + id);
            for (var i = 0; i < data.length; i++) {
                if (selfNode) {
                    break;
                }
                var obj = data[i];
                if (!obj || !obj.id) {
                    continue;
                }
                if (obj.id === id) {
                    console.log("ok...");
                    selfNode = obj;
                    break;
                } else {
                    if (obj.children.length > 0) {
                        if (num === cs) {
                            parentNode = obj;
                        }
                        getJ(id, obj.children, num + 1);
                    } else {
                        continue;
                    }
                }
            }
            if (!parentNode) {
                parentNode = null;
            }
            return {'parentNode': parentNode, 'selfNode': selfNode}
        }
        window.getFenlei = function (name, id) {
            var ss = getJ(id, fullData);
            console.log(ss);
            if (name === 'parentNode'){
                setData(ss.parentNode);
                setEntity(ss.parentNode);
            } else if (name === 'selfNode') {
                setData(ss.selfNode);
                setEntity(ss.selfNode);
            }
            parentNode = null;
            selfNode = null;
        };

        function getIds(list, data) {
            if (data.children.length === 0) {
                list.push(data.id);
            } else {
                for (var i = 0; i < data.children.length; i++) {
                    getIds(list, data.children[i]);
                }
            }
        }

        //加载页面主体部分的实体
        function setEntity(data) {
            var index = layer.load(2);
            var list = [];
            getIds(list, data);
            var csrfToken = $("[name='csrfmiddlewaretoken']").val();
            $.ajax({
                type: 'post',
                url: 'getEntity/',
                data: {'ids': list},
                headers: {"X-CSRFToken": csrfToken},
                success: function (data) {
                    $("#node").empty();
                    if (data.entities.length !== 0) {
                        for (var i = 0; i < data.entities.length; i++) {
                            $("#node").append(
                                '<span class="layui-badge layui-bg-orange">' +
                                '<a href="javascript:void(0);">' + data.entities[i].key + '</a>' +
                                '</span>\n' +
                                '<table id="list' + data.entities[i].key + '" style="width:100%; margin: 10px 15px;">\n' +
                                '<colgroup>\n' +
                                '<col width="25%">\n' +
                                '<col width="25%">\n' +
                                '<col width="25%">\n' +
                                '<col width="25%">\n' +
                                '</colgroup>\n' +
                                '</table>\n' +
                                '<hr/>'
                            );
                            var x = 0;
                            for (var j = 0; j < data.entities[i].value.length; j++) {
                                if (j % 4 === 0) {
                                    x = j;
                                    $("#list" + data.entities[i].key).append(
                                        '<tr id="list' + data.entities[i].key + x + '">\n' +
                                        '</tr>\n'
                                    );
                                }
                                $("#list" + data.entities[i].key + x).append(
                                    '<td>' +
                                    '<a href="' + data.entities[i].value[j].url + '">' + data.entities[i].value[j].name + '</a>' +
                                    '</td>\n'
                                );
                            }
                            if (data.entities[i].value.length % 4 !== 0) {
                                for (var k = 0; k < (4 - (data.entities[i].value.length % 4)); k++) {
                                    $("#list" + data.entities[i].key + x).append(
                                        '<td></td>'
                                    );
                                }
                            }
                        }
                        layer.close(index);
                    } else {
                        $("#node").empty().html("<center>无数据</center>");
                        layer.close(index);
                    }
                },
                error: function (result) {
                    $("#node").empty().html("<center>无数据</center>");
                    layer.close(index);
                }
            });
        }
    });
</script>
</body>
</html>